- name: Install k3s master
  hosts: master
  become: yes
  tasks:
    - name: Download and install k3s server
      shell: |
        curl -sfL https://get.k3s.io | sh -

    - name: Get k3s join token
      shell: cat /var/lib/rancher/k3s/server/node-token
      register: k3s_token

    - name: Save token for later use
      set_fact:
        k3s_node_token: "{{ k3s_token.stdout }}"

    - name: Copy kubeconfig to local machine
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ~/.kube/config
        flat: yes
      when: inventory_hostname in groups['master']

- name: Install k3s worker nodes
  hosts: nodes
  become: yes
  tasks:
    - name: Install k3s agent
      shell: |
        curl -sfL https://get.k3s.io | K3S_URL="https://{{ hostvars['master1'].ansible_host }}:6443" \
        K3S_TOKEN="{{ hostvars['master1'].k3s_node_token }}" sh -
